/*
 * Delay_line.c
 *
 * Created: 02.02.2014 14:00:29
 *  Author: Администратор
 */ 

#include "main.h"

unsigned int steps=0;
unsigned int speed=300;

//****************************************************************************************
// External Interrupt 0 service routine
//****************************************************************************************
ISR (INT0_vect)
{
	//---------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------
	return;
};

//****************************************************************************************
// Timer0 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	//---------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------
	return;
};

int main(void)
{
	
	unsigned int i=0x00;
	init_periphery ();
    while(1)
    {
        //TODO:: Please write your application code 
		//---------------------------------------------------------------------------------------
		if (CS==0x01)				
		{
			//---------------------------------------------------------------------------------------
			for (;((i<steps)&&(CS==0x01));i++)
			{
				//---------------------------------------------------------------------------------------
				if (CLK_OUT==0x00)
				{
					CLK_OUT_ON;
				}
				else
				{
					CLK_OUT_OFF;
				};
				//---------------------------------------------------------------------------------------
				for (unsigned int j=0x00;((j<speed)&&(CS==0x01));j++)
				{
					_delay_us(200);
				};
				//---------------------------------------------------------------------------------------
			};
			//---------------------------------------------------------------------------------------
		}else
		{
			//---------------------------------------------------------------------------------------
			unsigned int temp_steps=0x00;
			unsigned int temp_speed=0x00;
			//---------------------------------------------------------------------------------------
			for (unsigned char bit = 0; bit < 15; bit++) 
			{
				//---------------------------------------------------------------------------------------
				while(CLK==0x01)
				{
					_delay_us(1);
				};
				temp_steps |= S_DATA_IN;
				temp_steps <<= 1;
				while(CLK==0x00)
				{
					_delay_us(1);
				};
				//---------------------------------------------------------------------------------------
			};
			//---------------------------------------------------------------------------------------
			while(CS==0x01)
			{
				_delay_us(1);
			};
			//---------------------------------------------------------------------------------------
			for (unsigned char bit = 0; bit < 16; bit++)
			{
				//---------------------------------------------------------------------------------------
				while(CLK==0x01)
				{
					_delay_us(1);
				};
				temp_speed |= S_DATA_IN;
				temp_speed <<= 1;
				while(CLK==0x00)
				{
					_delay_us(1);
				};
				//---------------------------------------------------------------------------------------
			};
			//---------------------------------------------------------------------------------------
 			steps=temp_steps*2;
			speed=temp_speed;
			i=0x00;
			//---------------------------------------------------------------------------------------
			while(CS==0x00)
			{
				_delay_us(1);
			};
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
    };
};