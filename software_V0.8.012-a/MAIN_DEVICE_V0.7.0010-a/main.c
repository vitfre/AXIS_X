/*
 * LD.c
 *
 * Created: 11.02.2014 17:33:24
 *  Author: Администратор
 */ 

#include "main.h"

//****************************************************************************************
// Timer0 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	//---------------------------------------------------------------------------------------
	BUT_Debrief();
	//---------------------------------------------------------------------------------------
	return;
};
//****************************************************************************************
// Timer1 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER1_OVF_vect)
{
	//---------------------------------------------------------------------------------------
	// Reinitialize Timer1 value
	TCNT1H=0x0B;
	TCNT1L=0xDC;
	//---------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------
	return;
};

int main(void)
{
	//---------------------------------------------------------------------------------------
	unsigned char button = 0x00, menu_item_father = 0x00, menu_item_child = 0x01;
	unsigned int length_1 = 500, speed_1 = 8500, speed_2 = 6000;
	float temp = speed_2;
	//---------------------------------------------------------------------------------------
	init_mcu();
	BUT_Init();
	BUZZ_LD_INIT
	//---------------------------------------------------------------------------------------
	all_ok(16);
	//---------------------------------------------------------------------------------------
	init_LCD();
	uart_1_init();
	//Global enable interrupts
	sei();
	//---------------------------------------------------------------------------------------
	//beep_tone(50);
	//---------------------------------------------------------------------------------------
	Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
	//---------------------------------------------------------------------------------------
	uart_1_write(0xAA);
	uart_1_write(0xFF);
	//---------------------------------------------------------------------------------------
	all_ok(0);
	//---------------------------------------------------------------------------------------
	//beep_tone(50);
	//---------------------------------------------------------------------------------------
	//temp=((float)speed_2*5)/40;
	start_work(length_1,speed_1,temp);
	//---------------------------------------------------------------------------------------
    while(1)
    {
		//---------------------------------------------------------------------------------------
        //TODO:: Please write your application code 
		//---------------------------------------------------------------------------------------
		if (uart_1_rx_count())
		{
			if (uart_1_read()==0x55)
			{
				Func_reset();
			}else
			{
			};
		}else
		{
		};
		//---------------------------------------------------------------------------------------
		button=BUT_GetKey();
		//---------------------------------------------------------------------------------------
		switch (menu_item_father)
		{
			//---------------------------------------------------------------------------------------
			case 0x00 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_child++;
						beep_tone(5);
						if (menu_item_child>9)
						{
							beep_tone(50);
							menu_item_child=9;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_child--;
						beep_tone(5);
						if (menu_item_child>9)
						{
							beep_tone(50);
							menu_item_child=1;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_father=0x01;
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			case 0x01 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						speed_1++;
						beep_tone(5);
						if (speed_1>999)
						{
							beep_tone(50);
							speed_1=999;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						speed_1--;
						beep_tone(5);
						if (speed_1>999)
						{
							beep_tone(50);
							speed_1=0;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						unsigned char cnt=0x00;
						while((cnt<250)&&(BitVal(PIN_BUTTON, OK)==0))
						{
							cnt++;
							_delay_ms(4);
						};
						if (cnt<250)
						{
							beep_tone(5);
							menu_item_father=0x00;
							Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						} 
						else
						{
							beep_tone(50);
							menu_item_father=0x02;
							Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
							BUT_SetKey(0x00);
							//---------------------------------------------------------------------------------------
							start_work(length_1,speed_1,speed_2);
							//---------------------------------------------------------------------------------------
						};
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x04 :
					{
						//---------------------------------------------------------------------------------------
						speed_2++;
						beep_tone(5);
						if (speed_2>999)
						{
							beep_tone(50);
							speed_2=999;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x05 :
					{
						//---------------------------------------------------------------------------------------
						speed_2--;
						beep_tone(5);
						if (speed_2>999)
						{
							beep_tone(50);
							speed_2=0;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x06 :
					{
						//---------------------------------------------------------------------------------------
						length_1++;
						beep_tone(5);
						if (length_1>999)
						{
							beep_tone(50);
							length_1=999;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x07 :
					{
						//---------------------------------------------------------------------------------------
						length_1--;
						beep_tone(5);
						if (length_1>999)
						{
							beep_tone(50);
							length_1=0;
						};
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			case 0x02 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						beep_tone(5);
						menu_item_father=0x01;
						Main_menu (menu_item_father,menu_item_child,length_1,speed_1,speed_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x04 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x05 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x06 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x07 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			default :;
		};		//switch (button)	
		//---------------------------------------------------------------------------------------
		_delay_ms(50);
		//---------------------------------------------------------------------------------------
	};
};