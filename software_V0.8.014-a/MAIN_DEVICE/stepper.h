/*
 * stepper.h
 *
 * Created: 15.10.2014 23:10:54
 *  Author: Администратор
 */ 


#ifndef STEPPER_H_
#define STEPPER_H_
//---------------------------------------------------------------------------------------
#define F_CPU 16000000UL // or whatever may be your frequency
//---------------------------------------------------------------------------------------
#include <avr/io.h>
#include <util/delay.h>
//---------------------------------------------------------------------------------------
#define SET_DATA	(PORTD|=(1<<7));
#define CLR_DATA	(PORTD&=~(1<<7));
#define SET_CLK		(PORTD|=(1<<6));
#define CLR_CLK		(PORTD&=~(1<<6));
#define SET_CS_1	(PORTD|=(1<<5));
#define CLR_CS_1	(PORTD&=~(1<<5));
#define SET_CS_2	(PORTD|=(1<<4));
#define CLR_CS_2	(PORTD&=~(1<<4));
//---------------------------------------------------------------------------------------
#define _MOWER_EN	(PORTF|=(1<<5));	//
#define _MOWER_DIS	(PORTF&=~(1<<5));	//
#define _MOWER_ON	(PORTF|=(1<<4));	//
#define _MOWER_RES	(PORTF&=~(1<<4));	//
//---------------------------------------------------------------------------------------
#define DIR_UP		(PORTF|=(1<<7));	//
#define DIR_DOWN	(PORTF&=~(1<<7));	//
#define DIR_LEFT	(PORTF|=(1<<6));	//
#define DIR_RIGHT	(PORTF&=~(1<<6));	//
//---------------------------------------------------------------------------------------
/**************************************************************************
*   Function name : stepper_init
*   Returns :       нет
*   Parameters :    нет
*   Purpose :       
****************************************************************************/
void stepper_init(void)
{
	//---------------------------------------------------------------------------------------
	PORTD=0xF0;
	DDRD=0xFF;
	_delay_ms(10);
	//---------------------------------------------------------------------------------------
	PORTF=0x00;
	DDRF=0xF0;
	_delay_ms(10);
	//---------------------------------------------------------------------------------------
	_MOWER_EN
	_delay_ms(10);
	_MOWER_ON
	//---------------------------------------------------------------------------------------
	DIR_DOWN
	DIR_RIGHT
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//Пихаємо дані в нарнію
//****************************************************************************************
void start_work(unsigned int length_1,unsigned int speed_1,unsigned int speed_2)
{
	//---------------------------------------------------------------------------------------
	
	//unsigned int length_2 = ((unsigned long int)length_1*(unsigned long int)speed_2)/(unsigned long int)speed_1;
	unsigned int length_2 = ((double)length_1)*((double)((double)speed_1)/((double)speed_2));
	//speed_1=32000/speed_1;
	//speed_2=32000/speed_2;
	//---------------------------------------------------------------------------------------
	CLR_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((length_1)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	SET_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	_delay_us(20);
	//---------------------------------------------------------------------------------------
	CLR_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((speed_1)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	//SET_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	_delay_us(20);
	//---------------------------------------------------------------------------------------
	CLR_CS_2;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((length_2)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	SET_CS_2;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	_delay_us(20);
	//---------------------------------------------------------------------------------------
	CLR_CS_2;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((speed_2)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	SET_CS_1;
	SET_CS_2;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//****************************************************************************************
//****************************************************************************************
#endif /* STEPPER_H_ */