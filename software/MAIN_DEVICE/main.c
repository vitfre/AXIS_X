/*
 * main.c
 *MAIN_DEVICE_V0.7.0011-a
 * Created: 11.02.2014 17:33:24
 *  Author: Администратор
 */ 

#include "main.h"

//****************************************************************************************
// Timer0 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	//---------------------------------------------------------------------------------------
	BUT_Debrief();
	//---------------------------------------------------------------------------------------
	return;
};
//****************************************************************************************
// Timer1 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER1_OVF_vect)
{
	//---------------------------------------------------------------------------------------
	// Reinitialize Timer1 value
	TCNT1H=0x0B;
	TCNT1L=0xDC;
	//---------------------------------------------------------------------------------------
	if (cnt>1)
	{
		//---------------------------------------------------------------------------------------
		cnt--;
		//---------------------------------------------------------------------------------------
	} 
	else
	{
		//---------------------------------------------------------------------------------------
		stop_work();
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	return;
};

int main(void)
{
	//---------------------------------------------------------------------------------------
	unsigned char button = 0x00, menu_item_father = 0x00, menu_item_child = 0x01;
	unsigned int work_time = 1, time_1 = 0, time_2 = 8;
	//float temp = speed_2;
	//---------------------------------------------------------------------------------------
	init_mcu();
	BUT_Init();
	BUZZ_LD_INIT
	stepper_init();
	//---------------------------------------------------------------------------------------
	all_ok(16);
	//---------------------------------------------------------------------------------------
	init_LCD();
	uart_1_init();
	//Global enable interrupts
	sei();
	//---------------------------------------------------------------------------------------
	Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
	//---------------------------------------------------------------------------------------
	uart_1_write(0xAA);
	uart_1_write(0xFF);
	//---------------------------------------------------------------------------------------
	all_ok(0);
	//---------------------------------------------------------------------------------------
	start_work(time_1,time_2);
	cnt=work_time;
	//---------------------------------------------------------------------------------------
    while(1)
    {
		//---------------------------------------------------------------------------------------
        //TODO:: Please write your application code 
		//---------------------------------------------------------------------------------------
		if (uart_1_rx_count())
		{
			if (uart_1_read()==0x55)
			{
				Func_reset();
			}else
			{
			};
		}else
		{
		};
		//---------------------------------------------------------------------------------------
		button=BUT_GetKey();
		//---------------------------------------------------------------------------------------
		switch (menu_item_father)
		{
			//---------------------------------------------------------------------------------------
			case 0x00 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_child++;
						beep_tone(5);
						if (menu_item_child>9)
						{
							beep_tone(50);
							menu_item_child=9;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_child--;
						beep_tone(5);
						if (menu_item_child>9)
						{
							beep_tone(50);
							menu_item_child=1;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						menu_item_father=0x01;
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			case 0x01 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						time_1++;
						beep_tone(5);
						if (time_1>999)
						{
							beep_tone(50);
							time_1=999;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						time_1--;
						beep_tone(5);
						if (time_1>999)
						{
							beep_tone(50);
							time_1=0;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						unsigned char cnt=0x00;
						while((cnt<250)&&(BitVal(PIN_BUTTON, OK)==0))
						{
							cnt++;
							_delay_ms(4);
						};
						if (cnt<250)
						{
							beep_tone(5);
							menu_item_father=0x00;
							Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						} 
						else
						{
							beep_tone(50);
							menu_item_father=0x02;
							Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
							BUT_SetKey(0x00);
							//---------------------------------------------------------------------------------------
							start_work(time_1,time_2);
							//---------------------------------------------------------------------------------------
						};
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x04 :
					{
						//---------------------------------------------------------------------------------------
						time_2++;
						beep_tone(5);
						if (time_2>999)
						{
							beep_tone(50);
							time_2=999;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x05 :
					{
						//---------------------------------------------------------------------------------------
						time_2--;
						beep_tone(5);
						if (time_2>999)
						{
							beep_tone(50);
							time_2=0;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x06 :
					{
						//---------------------------------------------------------------------------------------
						work_time++;
						beep_tone(5);
						if (work_time>999)
						{
							beep_tone(50);
							work_time=999;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x07 :
					{
						//---------------------------------------------------------------------------------------
						work_time--;
						beep_tone(5);
						if (work_time>999)
						{
							beep_tone(50);
							work_time=0;
						};
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			case 0x02 :
			{
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
				switch (button)
				{
					//---------------------------------------------------------------------------------------
					case 0x01 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x02 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x03 :
					{
						//---------------------------------------------------------------------------------------
						beep_tone(5);
						menu_item_father=0x01;
						Main_menu (menu_item_father,menu_item_child,work_time,time_1,time_2);
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x04 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x05 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x06 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					case 0x07 :
					{
						//---------------------------------------------------------------------------------------
						
						//---------------------------------------------------------------------------------------
					};
					break;
					//---------------------------------------------------------------------------------------
					default :;
				};		//switch (button)
				//---------------------------------------------------------------------------------------
				//---------------------------------------------------------------------------------------
			};
			break;
			//---------------------------------------------------------------------------------------
			default :;
		};		//switch (button)	
		//---------------------------------------------------------------------------------------
		_delay_ms(50);
		//---------------------------------------------------------------------------------------
	};
};