/*
 * stepper.h
 *
 * Created: 15.10.2014 23:10:54
 *  Author: Администратор
 */ 


#ifndef STEPPER_H_
#define STEPPER_H_
//---------------------------------------------------------------------------------------
#define F_CPU 16000000UL // or whatever may be your frequency
//---------------------------------------------------------------------------------------
#include <avr/io.h>
#include <util/delay.h>
//---------------------------------------------------------------------------------------
#define SET_DATA	(PORTD|=(1<<7));
#define CLR_DATA	(PORTD&=~(1<<7));
#define SET_CLK		(PORTD|=(1<<6));
#define CLR_CLK		(PORTD&=~(1<<6));
#define SET_CS_1	(PORTD|=(1<<4));
#define CLR_CS_1	(PORTD&=~(1<<4));
#define SET_CS_2	(PORTD|=(1<<5));
#define CLR_CS_2	(PORTD&=~(1<<5));
//---------------------------------------------------------------------------------------
#define _MOWER_W	(PORTF&=~(1<<1));	TCNT1H=0x0B;TCNT1L=0xDC;	// Reinitialize Timer1 value
#define _MOWER_S	(PORTF|=(1<<1));	//
//---------------------------------------------------------------------------------------
#define _MOWER_EN	(PORTF|=(1<<2));	//
#define _MOWER_DIS	(PORTF&=~(1<<2));	//
#define _MOWER_ON	(PORTF|=(1<<3));	//
#define _MOWER_RES	(PORTF&=~(1<<3));	//
//---------------------------------------------------------------------------------------
#define DIR_LEFT	(PORTD|=(1<<0));	//
#define DIR_RIGHT	(PORTD&=~(1<<0));	//
#define DIR_UP		(PORTD|=(1<<1));	//
#define DIR_DOWN	(PORTD&=~(1<<1));	//
//---------------------------------------------------------------------------------------
/**************************************************************************
*   Function name : stepper_init
*   Returns :       нет
*   Parameters :    нет
*   Purpose :       
****************************************************************************/
void stepper_init(void)
{
	//---------------------------------------------------------------------------------------
	PORTD |= (1<<0)|(1<<1)|(1<<4)|(1<<5)|(1<<6)|(1<<7);
	DDRD |= (1<<0)|(1<<1)|(1<<4)|(1<<5)|(1<<6)|(1<<7);
	_delay_ms(10);
	PORTF |= (1<<1)|(1<<2)|(1<<3);
	DDRF |= (1<<1)|(1<<2)|(1<<3);
	//---------------------------------------------------------------------------------------
	_delay_ms(10);
	//---------------------------------------------------------------------------------------
	_MOWER_EN
	_delay_ms(10);
	_MOWER_ON
	//---------------------------------------------------------------------------------------
	DIR_DOWN
	DIR_RIGHT
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//Пихаємо дані в нарнію
//****************************************************************************************
void start_work(unsigned int time_1,unsigned int time_2)
{
	//---------------------------------------------------------------------------------------
// 	time_1=32000/time_1;
// 	time_2=32000/time_2;
	//---------------------------------------------------------------------------------------
	_MOWER_S
	_delay_ms(2);
	CLR_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((time_1)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	SET_CS_1;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	_delay_us(20);
	//---------------------------------------------------------------------------------------
	CLR_CS_2;
	_delay_us(10);
	//---------------------------------------------------------------------------------------
	for (unsigned char i=17;i>1;i--)
	{
		
		if ((((time_2)>>(i-2))&1))
		{
			SET_DATA
		}
		else
		{
			CLR_DATA
		};
		_delay_us(50);
		CLR_CLK
		_delay_us(50);
		SET_CLK
	};
	//---------------------------------------------------------------------------------------
	_delay_us(10);
	SET_CS_2;
	_delay_us(10);
	_MOWER_W
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//Стоп машина
//****************************************************************************************
void stop_work(void)
{
	//---------------------------------------------------------------------------------------
	_MOWER_S
	//---------------------------------------------------------------------------------------
};
//****************************************************************************************
//****************************************************************************************
//****************************************************************************************
#endif /* STEPPER_H_ */