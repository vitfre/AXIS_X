/*
 * Delay_line.c
 *ACCESSORY_DEVICE_V0.6.009-a
 * Created: 02.02.2014 14:00:29
 *  Author: Администратор
 */ 

#include "main.h"

unsigned int speed=30000;

//****************************************************************************************
// External Interrupt 0 service routine
//****************************************************************************************
ISR (INT0_vect)
{
	//---------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------
	return;
};

//****************************************************************************************
// Timer0 overflow interrupt service routine
//****************************************************************************************
ISR (TIMER0_OVF_vect)
{
	//---------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------
	return;
};

int main(void)
{
	//---------------------------------------------------------------------------------------
	init_periphery ();
	//---------------------------------------------------------------------------------------
    while(1)
    {
        //TODO:: Please write your application code 
		//---------------------------------------------------------------------------------------
		if (EN==0x00)				
		{
			//---------------------------------------------------------------------------------------
			if (CLK_OUT==0x00)
			{
				CLK_OUT_ON;
			}
			else
			{
				CLK_OUT_OFF;
			};
			//---------------------------------------------------------------------------------------
			for (unsigned int j=0x00;((j<speed)&&(EN==0x00));j++)
			{
				_delay_us(200);
			};
			//---------------------------------------------------------------------------------------
		}else
		{
			//---------------------------------------------------------------------------------------
			if (CS==0x00)
			{
				//---------------------------------------------------------------------------------------
				unsigned int temp_speed=0x00;
				//---------------------------------------------------------------------------------------
				for (unsigned char bit = 0; bit < 16; bit++)
				{
					//---------------------------------------------------------------------------------------
					while(CLK==0x01)
					{
						_delay_us(1);
					};
					temp_speed |= S_DATA_IN;
					temp_speed <<= 1;
					while(CLK==0x00)
					{
						_delay_us(1);
					};
					//---------------------------------------------------------------------------------------
				};
				//---------------------------------------------------------------------------------------
				if (temp_speed==0)
				{
					//---------------------------------------------------------------------------------------
					speed=1;
					//---------------------------------------------------------------------------------------
				} 
				else
				{
					//---------------------------------------------------------------------------------------
					speed=temp_speed;
					//---------------------------------------------------------------------------------------
				};
				//---------------------------------------------------------------------------------------
				while(CS==0x00)
				{
					_delay_us(1);
				};
				//---------------------------------------------------------------------------------------
			}
			else
			{
				
			};
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
    };
	//---------------------------------------------------------------------------------------
};